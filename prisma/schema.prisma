generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Links a Supabase user to their AzerothCore game account
// The actual game account lives in AzerothCore's MySQL database
// This just tracks the relationship and username
model GameAccount {
  id             String   @id @default(cuid())
  supabaseUserId String   @unique @map("supabase_user_id")
  gameUsername   String   @unique @map("game_username") @db.VarChar(17)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("game_accounts")
}

// Content types for the site
enum ContentType {
  release // Major update showcases
  blog    // Development updates, announcements
  wiki    // Feature documentation, guides
}

// Content managed by admin panel, displayed on public site
model Content {
  id            String      @id @default(cuid())
  type          ContentType
  slug          String      @unique
  title         String
  summary       String?     @db.Text
  body          Json        // Tiptap JSON format
  featuredImage String?     @map("featured_image")
  published     Boolean     @default(false)
  publishedAt   DateTime?   @map("published_at")
  authorId      String?     @map("author_id") // Admin panel user ID (for reference)
  authorName    String?     @map("author_name") // Denormalized for display
  metadata      Json        @default("{}")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@index([type, published, publishedAt])
  @@index([published, publishedAt])
  @@map("content")
}

// User roles for patcher access control
enum Role {
  user    // Default - can only access live environment
  tester  // Can access assigned environments
  admin   // Can access all environments and manage roles
}

enum RequestStatus {
  pending
  approved
  denied
}

// Tracks user roles and environment access
model UserRole {
  id             String   @id @default(cuid())
  supabaseUserId String   @unique @map("supabase_user_id")
  role           Role     @default(user)
  allowedEnvs    String[] @default([]) // For testers: ["dev", "test"]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("user_roles")
}

// Tester access requests
model TesterRequest {
  id             String        @id @default(cuid())
  supabaseUserId String        @unique @map("supabase_user_id")
  email          String
  reason         String?       @db.Text
  status         RequestStatus @default(pending)
  reviewedBy     String?       @map("reviewed_by") // Admin's supabase user ID
  reviewedAt     DateTime?     @map("reviewed_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  @@index([status, createdAt])
  @@map("tester_requests")
}